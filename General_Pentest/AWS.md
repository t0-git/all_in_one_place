## Connect with an access key and a secret key 

`aws configure --profile <name_it>`

Then enter your access key and secret key.

---

## Connect to an endpoint without key

`aws configure`

Then enter random with in access and secret key, choose a region name (us-west-1 for example) and a text format output. Try with empty access and secret key, and with random values.

Then enter the url, for example dynamodb : `aws dynamodb list-tables --endpoint-url <url>`

---

## List the resources

`aws s3 ls`
`aws s3 ls s3://<resource_found>`

`PRE` seems to be a folder.

- You can add --region <server>
For example us-east-1, ap-southeast-1 ...

---

## Describe instances 

`aws ec2 describe-instances`

- If you want to describe the instance userdata for example : 

`aws ec2 describe-instance-attribute --attribute userData --instance-id
<instance_id_found_previously>`

---

## Copy it

`aws s3 cp s3://<resource_found>/<file> .`

## Upload
	
`aws s3 cp s3://<resource_found/<file_to_upload>`

---

## Synchronize package with what's inside your folder (and try to change the permissions with acl to read some stuff)

`aws s3 sync . s3://<resource_found>/<folder> --acl public-read`

---

## dynamodb

### List tables 
	
`aws dynamodb list-tables`

### View content of the table
	
`aws dynamodb scan --table-name <table_name>`
	
---

## Cloudwatch

`aws logs`

The you have to specify the log group and the log stream. Use Pacu to extract it, or boto3 and python.

- To find log groups : `aws logs describe-log-groups`

- Easier way here : `awslogs`

---

## Lambda

`aws lambda list-functions`

- You can also check if you have multiple version : `aws lambda list-versions-by-function --function-name <functionName>`

- Then, if you have discovered a functionName, retrieve the code : 

`aws lambda get-function --function-name <FunctionName>`

- For a specific version : `aws lambda get-function --function-name <functionName> --qualifier <version_number>`

- To check which version is used, check if there's an alias for this function : `aws lambda list-aliases --function-name <function_name>`. If you have a routing Config parameters, it seems it use multiple versions, and the additionnalVersionWeights will tell us when the other version is used. For example : `"2": 0.10`. Version 2 will be used 10% of the time.

- If you found a key inside the source code, maybe you can access it because this is the format : `s3://<bucket>/<key>`, by `aws s3 cp s3://<bucket>/key .`

- Check layers : `aws lambda list-layers`
- Check each version of the layers if there are more than 1 : `aws lambda get-layer-version-by-arn --arn <arn>:<version>`

- The package.json file contains the version used by the functions.

---

## Apigateway

`aws apigateway get-rest-apis`

- Then, when you have the id : `https://<id>.execute-api.<server>.amazonaws.com`

- Checking for the stages : `aws apigateway get-stages --rest-api-id <id>`

- Access it : `https://<id>.execute-api.<server>.amazonaws.com/<stage>`
- Access it : `https://<id>.execute-api.<server>.amazonaws.com`

- Check resources : `aws apigateway get-resources --rest-api-id 43iqo53xr7`

- Then check method : `aws apigateway get-method --rest-api-id <rest_api_id> --resource-id <resource_id>
--http-method <http_method>`

If you need to find the code of the api to check what's going on, use lambda list-functions and maybe you'll find something associated

- Find api keys : `aws apigateway get-api-keys --include-values`

- Pass api key on an api endpoint if needed : `curl -X POST -H 'x-api-key: <api_key>'`

---

## Buckets

- Checking the bucket policy 

`aws s3api get-bucket-policy --bucket <bucket>

Here, if you have something like this at the end : 
![fa612592c8d477c02e5f671a2d37b115.png](../_resources/250be5f2f5a94fc9859421bc6f3c1b21.png)
 The IAM user John has excessive privileges over a folder in the S3 bucket.
The ARN of the resource with excessive privileges:
`arn:aws:s3:::users-personal-files/Documents/james`

---

## S3 buckets

`aws s3api list-objects --bucket <bucket>`

list versions : 

`aws s3api list-object-versions --bucket <bucket>`

Downloading versions : `aws s3api get-object --bucket <bucket> --key <key> --version-id <version> <name_of_output_file>`

---

## AWS KMS

- Encryption and Key Management web Service.

- decipher : `aws kms decrypt --ciphertext-blob <encrypted_thing>`. For example, if this is stored in a local file : `fileb://<file>`

If you can not, you need to know who have the right to do that.

### Policy on key

- List keys : `aws kms list-keys`

- Find the KMS ARN needed with `aws lambda list-functions` to identify the needed ID. Then retrieve the default policy : `aws kms get-key-policy --key-id <key_id>
--policy-name default`. If you want to beautify the result : `--output text`. After that, you'll know which role you need to have to decrypt, and find the appropriate session_token, access_key and secret_key (Use it : `export AWS_SESSION_TOKEN=<...>` `export AWS_ACCESSS_KEY=<...>` ...).

- After you found it, if you want to check your IAM user or role : `aws sts get-caller-identity`

echo AQICAHi7+9ngknhMkz0sb+LYfPQqw3Oupegu4Y5dqgMw9JThIQEsuEXoJgp7K5CCZmy4DGHaAAAAfjB8BgkqhkiG9w0BBwagbzBtAgEAMGgGCSqGSIb3DQEHATAeBglghkgBZQMEAS4wEQQMdjbjfhorKb6HMIG4AgEQgDuwWQVNClcMu1GQgZdJUj/RG/4vaFEdT8wfRKWEWTZz84OM443vrn41/Qy5qypysm+3729SJ7sCjOfuGg== | base64 -d >

## Enumerate and exploit AWS instances

- install `pacu`
- launch it (need to be root to use the tool completely)
- set your keys : `set_keys`
- `list` to view what you can do
- run it : `run <command>`

- scoutsuite : `scoutsuite aws`
